import fastify from 'fastify';
import fastifyEnv from '@fastify/env';
import fastifyIo from 'fastify-socket.io';
import cors from '@fastify/cors';

const PORT = 8000;

const server = fastify({
	logger: true,
});

server.register(cors, {});
server.register(fastifyIo, {
	cors: {
		origin: '*',
	},
});

server.get('/', async (req, res) => {
	return { hello: 'mom' };
});
(async () => {
	await server.ready();

	server.io.on('connection', socket => {
		console.log('socket is initialized');

		socket.on('on:share-start', obj => {
			console.log(obj);
		});
		socket.on('test', txt => {
			console.log('hello there');
			socket.broadcast.emit('test2', txt);
		});

		socket.on('error', err => {
			socket.disconnect();
		});
		socket.on('disconnect', () => {
			console.log('disconnected');
		});
	});
})();
const start = async () => {
	try {
		await server.listen({ port: PORT });
		console.log(`server listening on ${PORT}`);
	} catch (err) {
		server.log.error(err);
		process.exit(1);
	}
};
start();
